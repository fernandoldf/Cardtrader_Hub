{% extends "base.html" %}

{% block title %}Card Recognition - Cardtrader Hub{% endblock %}

{% block content %}
<div class="container upload-console-container">
    {# T√≠tulo e Subt√≠tulo Gameificados #}
    <h2>INITIATE CARD SCAN</h2>
    <p class="text-secondary">Load data target (Image: PNG, JPG, JPEG) up to 5MB for analysis.</p>
    
    {# Bloco de Mensagens (Flash Messages) #}
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            <div class="message-log-group">
                {% for category, message in messages %}
                    {# Usando classes de alerta gameificadas baseadas no tema CSS #}
                    <div class="alert system-message-box alert-{{ category }}">
                        <span class="alert-icon">
                            {% if category == 'error' %} üõë 
                            {% elif category == 'warning' %} ‚ö†Ô∏è 
                            {% else %} ‚ÑπÔ∏è 
                            {% endif %}
                        </span>
                        {{ message }}
                    </div>
                {% endfor %}
            </div>
        {% endif %}
    {% endwith %}
    
    {# Formul√°rio de Upload #}
    <form id="uploadForm" class="form" action="{{ url_for('card_recognition') }}" method="post" enctype="multipart/form-data">
        <div class="file-input-wrapper">
            {# O input √© mantido #}
            <input type="file" name="card_image" id="fileInput" accept="image/png,image/jpeg,image/jpg,image/heic" required>
            {# O label √© atualizado para o tema #}
            <span class="file-input-label" id="fileLabel">‚´∏ SELECT DATA FILE ‚´∑</span>
        </div>
        {# Bot√£o de A√ß√£o #}
        <button type="submit" class="btn btn-full" id="submitBtn" disabled>START SCAN</button>
    </form>

    {# Link de Navega√ß√£o #}
    <a href="{{ url_for('home') }}" class="home-link">RETURN TO MAIN CONSOLE</a>
</div>

{# O JavaScript foi atualizado para usar a nova terminologia de "SCANNING DATA" #}
<script>
    const fileInput = document.getElementById('fileInput');
    const fileLabel = document.getElementById('fileLabel');
    const submitBtn = document.getElementById('submitBtn');
    const uploadForm = document.getElementById('uploadForm');
    const MAX_FILE_SIZE = 5 * 1024 * 1024; // 5MB
    const DEFAULT_LABEL = '‚´∏ SELECT DATA FILE ‚´∑';

    fileInput.addEventListener('change', () => {
        if (fileInput.files.length > 0) {
            const file = fileInput.files[0];
            fileLabel.textContent = `[FILE SELECTED]: ${file.name}`; // Feedback mais detalhado
            fileLabel.style.borderColor = 'var(--accent-color)'; // Feedback visual

            if (file.size > MAX_FILE_SIZE) {
                alert('[ERROR] FILE SIZE LIMIT EXCEEDED: File is larger than 5MB. Please choose a smaller file.');
                fileLabel.textContent = '[ERROR] SIZE EXCEEDED'; // Alerta visual no label
                fileLabel.style.borderColor = '#e53e3e';
                submitBtn.disabled = true;
            } else {
                submitBtn.disabled = false;
            }
        } else {
            fileLabel.textContent = DEFAULT_LABEL;
            fileLabel.style.borderColor = 'var(--border-color)';
            submitBtn.disabled = true;
        }
    });

    if (submitBtn) {
        submitBtn.dataset.originalText = submitBtn.textContent;
    }

    function disableSubmitButton() {
        if (!submitBtn) return;
        if (submitBtn.dataset.submitted === 'true') return false;
        
        // **MUDAN√áA DE ESTADO DE CARREGAMENTO**
        submitBtn.textContent = 'SCANNING DATA...'; 
        
        submitBtn.disabled = true;
        submitBtn.dataset.submitted = 'true';
        submitBtn.setAttribute('aria-disabled', 'true');
        return true;
    }

    function reenableSubmitButton() {
        if (!submitBtn) return;
        submitBtn.disabled = false;
        submitBtn.dataset.submitted = 'false';
        submitBtn.setAttribute('aria-disabled', 'false');
        submitBtn.textContent = submitBtn.dataset.originalText || 'START SCAN';
    }

    window.reenableSubmitButton = reenableSubmitButton;

    if (uploadForm) {
        uploadForm.addEventListener('submit', (e) => {
            disableSubmitButton();
        });
    }
</script>
{% endblock %}