{% extends "base.html" %}

{% block title %}Card Recognition - Cardtrader Hub{% endblock %}

{% block content %}
<div class="container">
    <h2>Card Recognition</h2>
    <p class="text-secondary">Upload an image of a card (PNG, JPG, JPEG) up to 5MB.</p>
    
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                <div class="alert alert-{{ category }}">{{ message }}</div>
            {% endfor %}
        {% endif %}
    {% endwith %}
    
    <form id="uploadForm" class="form" action="{{ url_for('card_recognition') }}" method="post" enctype="multipart/form-data">
        <div class="file-input-wrapper">
            <input type="file" name="card_image" id="fileInput" accept="image/png,image/jpeg,image/jpg,image/heic" required>
            <span class="file-input-label" id="fileLabel">Choose a file...</span>
        </div>
        <button type="submit" class="btn btn-full" id="submitBtn" disabled>Upload</button>
    </form>

    <a href="{{ url_for('home') }}" class="home-link">Back to Home</a>
</div>

<script>
    const fileInput = document.getElementById('fileInput');
    const fileLabel = document.getElementById('fileLabel');
    const submitBtn = document.getElementById('submitBtn');
    const uploadForm = document.getElementById('uploadForm');
    const MAX_FILE_SIZE = 5 * 1024 * 1024; // 5MB

    fileInput.addEventListener('change', () => {
        if (fileInput.files.length > 0) {
            const file = fileInput.files[0];
            fileLabel.textContent = file.name;

            if (file.size > MAX_FILE_SIZE) {
                alert('Error: File is larger than 5MB. Please choose a smaller file.');
                submitBtn.disabled = true;
            } else {
                submitBtn.disabled = false;
            }
        } else {
            fileLabel.textContent = 'Choose a file...';
            submitBtn.disabled = true;
        }
    });

    // Prevent double submissions: disable the submit button after click/submit
    // and provide a way to re-enable if the request is handled via AJAX.
    // Store original text so we can restore it if needed.
    if (submitBtn) {
        submitBtn.dataset.originalText = submitBtn.textContent;
    }

    function disableSubmitButton() {
        if (!submitBtn) return;
        // If already submitted, block further submissions
        if (submitBtn.dataset.submitted === 'true') return false;
        submitBtn.disabled = true;
        submitBtn.dataset.submitted = 'true';
        submitBtn.setAttribute('aria-disabled', 'true');
        submitBtn.textContent = 'Processing...';
        return true;
    }

    function reenableSubmitButton() {
        if (!submitBtn) return;
        submitBtn.disabled = false;
        submitBtn.dataset.submitted = 'false';
        submitBtn.setAttribute('aria-disabled', 'false');
        submitBtn.textContent = submitBtn.dataset.originalText || 'Upload';
    }

    // Expose reenable function so other scripts (e.g., AJAX handlers) can call it
    window.reenableSubmitButton = reenableSubmitButton;

    if (uploadForm) {
        uploadForm.addEventListener('submit', (e) => {
            // Disable button immediately to prevent double clicks while the
            // browser performs the form submission or an AJAX request.
            disableSubmitButton();
            // If other code calls e.preventDefault() to perform AJAX,
            // they should call `window.reenableSubmitButton()` when finished
            // (on error or when re-enabling is desired).
        });
    }
</script>
{% endblock %}